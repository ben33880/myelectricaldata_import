name: "[DEBUG] Test DockerHub Login"

on:
  workflow_dispatch:

jobs:
  test-dockerhub:
    runs-on: ubuntu-latest
    steps:
      - name: Afficher les variables d'environnement
        run: |
          echo "IMAGE_REPO (username attendu) = ${{ secrets.DOCKERHUB_USERNAME }}"
          echo "IMAGE_NAME (si d√©fini dans d'autres workflows) = myelectricaldatavm"

      - name: V√©rifier que le secret DOCKERHUB_TOKEN est bien d√©fini
        run: |
          if [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "‚ùå DOCKERHUB_TOKEN n'est PAS d√©fini"
            exit 1
          else
            echo "‚úÖ DOCKERHUB_TOKEN est d√©fini"
          fi

      - name: Tentative login DockerHub
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: V√©rifier acc√®s aux repos
        run: |
          echo "üëâ Test de r√©cup√©ration d'informations sur le repo"
          curl -s -o /dev/null -w "%{http_code}\n" https://hub.docker.com/v2/repositories/${{ secrets.DOCKERHUB_USERNAME }}/
          echo "üëâ Liste des images d√©j√† publi√©es (limit√© √† 5):"
          curl -s https://hub.docker.com/v2/repositories/${{ secrets.DOCKERHUB_USERNAME }}/?page_size=5 | jq .

      - name: V√©rifier si image myelectricaldatavm existe d√©j√†
        run: |
          echo "üëâ V√©rification si image existe d√©j√†"
          curl -s https://hub.docker.com/v2/repositories/${{ secrets.DOCKERHUB_USERNAME }}/myelectricaldatavm/tags/?page_size=5 | jq .
